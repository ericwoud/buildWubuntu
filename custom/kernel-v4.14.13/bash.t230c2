#!/bin/bash
#$sudo wget -N https://github.com/osmc/dvb-firmware-osmc/blob/master/dvb-demod-si2168-d60-01.fw?raw=true \
#     -P $rootfsdir/lib/firmware
#$sudo wget -N https://github.com/osmc/dvb-firmware-osmc/blob/master/dvb-tuner-si2141-a10-01.fw?raw=true \
#     -P $rootfsdir/lib/firmware
#$sudo wget -N https://github.com/crazycat69/linux_media/raw/latest/drivers/media/dvb-frontends/si2168.c \
#     -P $kerneldir/drivers/media/dvb-frontends
#$sudo wget -N https://github.com/crazycat69/linux_media/raw/latest/drivers/media/dvb-frontends/si2168.h \
#     -P $kerneldir/drivers/media/dvb-frontends
#$sudo wget -N https://github.com/crazycat69/linux_media/raw/latest/drivers/media/dvb-frontends/si2168_priv.h \
#     -P $kerneldir/drivers/media/dvb-frontends
#$sudo wget -N https://github.com/crazycat69/linux_media/raw/latest/drivers/media/usb/dvb-usb/cxusb.c \
#     -P $kerneldir/drivers/media/usb/dvb-usb
#$sudo wget -N https://github.com/crazycat69/linux_media/raw/latest/drivers/media/usb/dvb-usb/cxusb.h \
#     -P $kerneldir/drivers/media/usb/dvb-usb
wget -nv -N https://bitbucket.org/CrazyCat/media_build/downloads/linux-media-LATEST.tar.bz2 
wget -nv -N https://bitbucket.org/CrazyCat/media_build/downloads/dvb-firmwares.tar.bz2 
$sudo tar --overwrite -vxjC $kerneldir -f linux-media-LATEST.tar.bz2 \
      drivers/media/dvb-frontends/si2168.c \
      drivers/media/dvb-frontends/si2168.h \
      drivers/media/dvb-frontends/si2168_priv.h \
      drivers/media/usb/dvb-usb/cxusb.c \
      drivers/media/usb/dvb-usb/cxusb.h 
$sudo tar --overwrite -vxjC $kerneldir -f dvb-firmwares.tar.bz2 \
      dvb-demod-si2168-d60-01.fw \
      dvb-tuner-si2141-a10-01.fw 
$sudo cat <<EOT | $sudo tee -a $kerneldir/.config
CONFIG_I2C_MUX=m
CONFIG_MEDIA_SUPPORT=m
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_TMPFS_XATTR=y
CONFIG_DVB_CORE=m
CONFIG_DVB_MAX_ADAPTERS=16
CONFIG_DVB_NET=y
CONFIG_DVB_SI2168=m
CONFIG_DVB_TUNER_DIB0070=m
CONFIG_DVB_USB=m
CONFIG_DVB_USB_CXUSB=m
CONFIG_MEDIA_ATTACH=y
CONFIG_MEDIA_DIGITAL_TV_SUPPORT=y
CONFIG_MEDIA_TUNER=m
CONFIG_MEDIA_TUNER_SI2157=m
CONFIG_MEDIA_USB_SUPPORT=y
EOT
$sudo patch -d $kerneldir -p1 -N -r - <<'EOF'
--- a/drivers/media/dvb-frontends/si2168_priv.h	2018-02-17 13:57:35.367171260 +0100
+++ b/drivers/media/dvb-frontends/si2168_priv.h	2018-02-20 08:04:42.000000000 +0100
@@ -21 +21 @@
-#include <media/dvb_frontend.h>
+#include "dvb_frontend.h"
EOF

